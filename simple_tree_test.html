<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Tree Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        border: 2px solid #007bff;
        padding: 20px;
        margin: 20px 0;
      }
      .tree-container {
        width: 100%;
        height: 400px;
        border: 2px solid #28a745;
        background: #f8f9fa;
        position: relative;
      }
      .console {
        background: #f5f5f5;
        padding: 10px;
        font-family: monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
      }
    </style>
  </head>
  <body>
    <h1>Simple Tree Diagram Test</h1>

    <div class="container">
      <h3>Test Data</h3>
      <ul id="test-list" class="class-diagram0">
        <li>
          <a href="#parent">Parent Class</a>
          <ul>
            <li class="original"><a href="#child1">Child1 (Original)</a></li>
            <li><a href="#child2">Child2</a></li>
          </ul>
        </li>
      </ul>
    </div>

    <div class="container">
      <h3>Tree Diagram Container</h3>
      <div id="tree-container" class="tree-container">
        <div
          style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
          "
        >
          Waiting for tree diagram...
        </div>
      </div>
    </div>

    <div class="container">
      <h3>Console Output</h3>
      <div id="console" class="console">Loading...</div>
    </div>

    <!-- Load libraries -->
    <script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
    <script src="https://unpkg.com/cytoscape@3.26.0/dist/cytoscape.min.js"></script>
    <script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

    <script>
      const consoleDiv = document.getElementById("console");

      function log(message) {
        console.log(message);
        consoleDiv.textContent +=
          new Date().toLocaleTimeString() + ": " + message + "\n";
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }

      function error(message) {
        console.error(message);
        consoleDiv.textContent +=
          new Date().toLocaleTimeString() + ": ERROR: " + message + "\n";
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }

      // Check libraries
      log("Checking libraries...");
      log("dagre: " + (typeof dagre !== "undefined" ? "loaded" : "NOT LOADED"));
      log(
        "cytoscape: " +
          (typeof cytoscape !== "undefined" ? "loaded" : "NOT LOADED")
      );
      log(
        "cytoscapeDagre: " +
          (typeof cytoscapeDagre !== "undefined" ? "loaded" : "NOT LOADED")
      );

      // Register extension
      if (
        typeof cytoscape !== "undefined" &&
        typeof cytoscapeDagre !== "undefined"
      ) {
        try {
          cytoscape.use(cytoscapeDagre);
          log("✓ cytoscape-dagre extension registered successfully");
        } catch (e) {
          error("Failed to register extension: " + e.message);
        }
      } else {
        error("Cannot register extension - libraries not loaded");
      }

      function createTreeDiagram() {
        log("\n=== Creating Tree Diagram ===");

        const container = document.getElementById("tree-container");
        const listElement = document.getElementById("test-list");

        log("Container: " + (container ? "found" : "NOT FOUND"));
        log("List element: " + (listElement ? "found" : "NOT FOUND"));
        log(
          "Container dimensions: " +
            container.offsetWidth +
            "x" +
            container.offsetHeight
        );

        // Simple data creation
        const nodes = [
          { data: { id: "parent", label: "Parent Class" } },
          {
            data: { id: "child1", label: "Child1 (Original)" },
            classes: "original",
          },
          { data: { id: "child2", label: "Child2" } },
        ];

        const edges = [
          { data: { id: "edge1", source: "parent", target: "child1" } },
          { data: { id: "edge2", source: "parent", target: "child2" } },
        ];

        const elements = { nodes, edges };
        log("Elements created: " + JSON.stringify(elements, null, 2));

        const style = [
          {
            selector: "node",
            style: {
              "background-color": "#ffffff",
              "border-color": "#333333",
              "border-width": 2,
              label: "data(label)",
              "text-valign": "center",
              "text-halign": "center",
              "font-size": "16px",
              "font-weight": "500",
              width: "220px",
              height: "60px",
              shape: "roundrectangle",
              "text-wrap": "wrap",
              "text-max-width": "210px",
              "text-overflow-wrap": "anywhere",
            },
          },
          {
            selector: "node.original",
            style: {
              "background-color": "#007bff",
              color: "#ffffff",
              "border-color": "#0056b3",
              "font-weight": "600",
            },
          },
          {
            selector: "edge",
            style: {
              width: 2,
              "line-color": "#666666",
              "target-arrow-color": "#666666",
              "target-arrow-shape": "triangle",
              "curve-style": "bezier",
            },
          },
        ];

        try {
          log("Creating cytoscape instance...");

          // Clear the waiting message
          container.innerHTML = "";

          const cy = cytoscape({
            container: container,
            elements: elements,
            style: style,
            layout: {
              name: "dagre",
              rankDir: "TB",
              spacingFactor: 1.2,
              nodeSep: 40,
              rankSep: 80,
            },
            minZoom: 0.1,
            maxZoom: 3,
          });

          log("✓ Cytoscape instance created successfully!");
          log("Nodes in graph: " + cy.nodes().length);
          log("Edges in graph: " + cy.edges().length);
          log(
            "Container dimensions: " +
              container.offsetWidth +
              "x" +
              container.offsetHeight
          );

          // Force layout application and fit
          setTimeout(() => {
            log("Applying layout...");
            const layout = cy.layout({
              name: "dagre",
              rankDir: "TB",
              spacingFactor: 1.2,
              nodeSep: 40,
              rankSep: 80,
            });
            layout.run();

            layout.one("layoutstop", () => {
              cy.fit();
              log("✓ Layout completed and view fitted");
            });
          }, 100);

          // Hide original list
          listElement.style.display = "none";
          log("Original list hidden");
        } catch (e) {
          error("Failed to create cytoscape instance: " + e.message);
          error("Stack trace: " + e.stack);

          // Show error in container
          container.innerHTML =
            '<div style="color: red; padding: 20px; text-align: center;">Error: ' +
            e.message +
            "</div>";
        }
      }

      // Run when page loads
      document.addEventListener("DOMContentLoaded", function () {
        log("Page loaded");
        setTimeout(createTreeDiagram, 1000);
      });
    </script>
  </body>
</html>
